const { spawn, exec } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('\nğŸš€ MOTABEA - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©');
console.log('=====================================\n');

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
const requiredFiles = [
  'server/index.js',
  'src/App.tsx',
  'vite.config.ts',
  'package.json'
];

console.log('ğŸ“ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª...');
for (const file of requiredFiles) {
  if (!fs.existsSync(file)) {
    console.error(`âŒ Ù…Ù„Ù Ù…ÙÙ‚ÙˆØ¯: ${file}`);
    process.exit(1);
  }
}
console.log('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©\n');

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù .env Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
if (!fs.existsSync('.env')) {
  const envContent = `NODE_ENV=development
PORT=5001
JWT_SECRET=motabea_school_management_secret_key_2024
DATABASE_URL=mysql://localhost:3306/motabea_school
CORS_ORIGIN=http://localhost:3003`;
  
  fs.writeFileSync('.env', envContent);
  console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù .env');
} else {
  console.log('âœ… Ù…Ù„Ù .env Ù…ÙˆØ¬ÙˆØ¯');
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
if (!fs.existsSync('node_modules')) {
  console.log('ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª...');
  exec('npm install', (error) => {
    if (error) {
      console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª:', error);
      process.exit(1);
    }
    console.log('âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª\n');
    startServers();
  });
} else {
  console.log('âœ… Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ù…Ø«Ø¨ØªØ©\n');
  startServers();
}

function killExistingProcesses() {
  return new Promise((resolve) => {
    exec('taskkill /F /IM node.exe /T', () => {
      exec('taskkill /F /IM npm.exe /T', () => {
        setTimeout(resolve, 2000);
      });
    });
  });
}

async function startServers() {
  console.log('ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©...');
  await killExistingProcesses();
  console.log('âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©\n');

  // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ
  console.log('ğŸ”§ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ...');
  const backend = spawn('node', ['server/index.js'], {
    stdio: 'pipe',
    shell: true
  });

  backend.stdout.on('data', (data) => {
    console.log(`[Backend] ${data.toString().trim()}`);
  });

  backend.stderr.on('data', (data) => {
    console.error(`[Backend Error] ${data.toString().trim()}`);
  });

  // Ø§Ù†ØªØ¸Ø§Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ
  await new Promise(resolve => setTimeout(resolve, 5000));

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ
  const healthCheck = spawn('curl', ['-s', 'http://localhost:5001/api/health'], {
    stdio: 'pipe',
    shell: true
  });

  healthCheck.on('close', (code) => {
    if (code === 0) {
      console.log('âœ… Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­\n');
    } else {
      console.log('âš ï¸ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­\n');
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
    console.log('ğŸ¨ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©...');
    console.log('=====================================');
    console.log('ğŸŒ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©: http://localhost:3003');
    console.log('ğŸ”§ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ: http://localhost:5001');
    console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: admin');
    console.log('ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: admin123');
    console.log('=====================================\n');

    const frontend = spawn('npm', ['run', 'dev'], {
      stdio: 'inherit',
      shell: true
    });

    frontend.on('close', (code) => {
      console.log(`Frontend exited with code ${code}`);
      backend.kill();
    });
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
  process.on('SIGINT', () => {
    console.log('\nğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®ÙˆØ§Ø¯Ù…...');
    backend.kill();
    process.exit();
  });
}

module.exports = startServers;
